---
title: 聊聊关键字synchronized和volatile
date: 2023-06-14 20:16:57
permalink: /pages/e19c5d/
---
# 聊聊 synchronized 和 volatile

## synchronized 关键字

### 什么是 synchronized 关键字？

`synchronized` 是 Java 中的一个关键字，翻译成中文是同步的意思。

主要解决的是：多个线程之间访问资源的同步性。可以保证被它修饰的方法或者代码块在任意时刻只能有一个线程执行。

***使用方式***

使用 `synchronized` 关键字时，需要**在方法或代码块上加锁**，以确保同一时间只有一个线程可以执行这段代码；

### 构造方法可以用 synchronized 修饰么？

不可以。

因为构造方法本身就属于线程安全的，不存在同步的构造方法一说。

### synchronized 的底层原理是什么？

- `synchronized` 同步语句块时

  使用的是 `monitorenter` 和 `monitorexit` 指令，其中 `monitorenter` 指令指向同步代码块的开始位置，`monitorexit` 指令则指明同步代码块的结束位置。

- `synchronized` 修饰方法时

  没有 `monitorenter` 指令和 `monitorexit` 指令，取而代之的是 `ACC_SYNCHRONIZED` 标识，该标识指明了该方法是一个同步方法。

## volatile 关键字

### 什么是 volatile 关键字？

volatile 关键字是 Java 中用于**保证变量可见性**和**禁止指令重排序优化**的一种机制。只能保证单个变量的原子性，不能保证复合操作的原子性。

### volatile 关键字解决了什么问题？

volatile 关键字主要解决了两个问题：**可见性问题**和**指令重排序问题**。

1. 可见性问题 

   在多线程环境下，每个线程都有自己的工作内存，用于存储线程需要使用的变量。**当一个线程修改了某个变量的值时，这个变量的值并不会立即被其他线程看到，需要将该变量的值同步到主内存中，其他线程才能看到该变量的最新值**。

   而 volatile 关键字可以保证变量的修改对其他线程可见，从而避免了可见性问题。

2. 指令重排序问题 

   在多线程环境下，为了提高程序性能，CPU 可能会对指令进行重排序，但指令重排序可能会导致程序出现意想不到的结果。例如，在一个双重检查锁定中，如果不使用 volatile 关键字，可能会导致另一个线程获取到未完全初始化的对象，从而出现问题。

   而使用 volatile 关键字可以**禁止指令重排序优化**，保证了程序的正确性。

## synchronized 和 volatile 有什么区别？

`synchronized` 关键字和 `volatile` 关键字是两个**互补的存在**，而不是对立的存在！

- `volatile` 关键字是线程同步的轻量级实现，所以 `volatile` 性能肯定比`synchronized` 关键字要好 。但是 `volatile` 关键字只能用于单个变量而 `synchronized` 关键字可以修饰方法以及代码块。
- `volatile` 关键字能保证数据的可见性，但不能保证数据的原子性。`synchronized` 关键字两者都能保证。
- `volatile` 关键字主要用于解决**单个变量在多个线程之间的可见性**，而 `synchronized` 关键字解决的是**多线程之间的资源同步**。

